version: v1.0
name: Kafka Tutorials pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

promotions:
  - name: Deploy to live site
    pipeline_file: live-site-deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - ^release$

  - name: Deploy to staging site
    pipeline_file: staging-site-deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - ^master$

blocks:
  - name: Build the website
    task:
      prologue:
        commands:
          - checkout
          - cache restore
          - npm install
          - gem install bundler --no-ri --no-rdoc
          - bundle install
          - cache store
      jobs:
        - name: Compile with Jekyll
          commands:
            - bundle exec jekyll build --baseurl "/$SEMAPHORE_GIT_BRANCH/$SEMAPHORE_GIT_SHA"
            - cache store site-$SEMAPHORE_GIT_SHA _site

  - name: Run the tests
    execution_time_limit:
      minutes: 15
    task:
      prologue:
        commands:
          - checkout
          - sudo pip3 install -e harness_runner/
      jobs:
        - name: KStreams emit a final result from a time window
          commands:
            - make -C _includes/tutorials/window-final-result/kstreams/code tutorial
